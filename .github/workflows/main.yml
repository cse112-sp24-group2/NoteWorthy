name: CI
on: push
jobs:
  build:
    # Installs Yarn (npm alternative) to run jest tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Installs
        run: |
          npm install jest
          npm install --save-dev node-fetch
          npm install -D jest-environment-jsdom
          npm ci -l verbose
      - name: Check linting and formatting
        run: npm run lint:check
      - name: HTML5 Validator
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: source/
          css: true
          skip_git_check: true
      - name: Start server
        run: |
          npm start &
        env:
          CI: true
      # - name: Run TESTS
      #   run: |
      #     npm run test
      #   env:
      #     NODE_OPTIONS: --experimental-vm-modules
      #     CI: true
      - name: Minify JS
        run: |
          npm install uglify-js -g
          find ./source/scripts -name "*.js" -exec uglifyjs {} -o {} --compress --mangle --module \;
      - name: Google Lighthouse
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

jobs:
  Build:
    runs-on: [ubuntu-latest]
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Install JSDocs
        run: npm i -g jsdoc && npm install -g jsdoc-tsimport-plugin
      - name: Build JSDocs
        run: jsdoc -c jsdoc.json
      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './'
          name: github-pages
  Deploy:
    needs: Build
    runs-on: [ubuntu-latest]
    environment: 
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:  
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

